<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SpellQuest: Epic Spelling Adventure</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color-lvl1: #87CEEB; /* Sky Blue */
            --bg-color-lvl2: #FFB6C1; /* Light Pink */
            --bg-color-lvl3: #9370DB; /* Medium Purple */
            --bg-color-lvl4: #2F4F4F; /* Dark Slate Gray */
            --text-color: #333;
            --accent-color: #FFD700;
            --danger-color: #FF6347;
            --success-color: #32CD32;
        }

        * {
            box-sizing: border-box;
            touch-action: manipulation; /* Improves touch response */
        }

        body {
            font-family: 'Press Start 2P', cursive;
            background-color: var(--bg-color-lvl1);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            overflow: hidden; /* Prevent scrolling */
            transition: background-color 1s ease;
        }

        /* --- UI Layout --- */
        #game-container {
            width: 100%;
            max-width: 600px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 10px;
            position: relative;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            font-size: 0.8rem;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .stats-box {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #hearts-container {
            color: var(--danger-color);
            font-size: 1.2rem;
            margin-bottom: 5px;
        }

        /* --- Battle Arena --- */
        #arena {
            flex-grow: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            margin: 10px 0;
        }

        .character {
            font-size: 3rem;
            position: relative;
            transition: transform 0.2s;
        }

        #hero { transform: scaleX(-1); } /* Face right */
        
        .health-bar-container {
            width: 80px;
            height: 10px;
            background: #555;
            border: 2px solid #000;
            margin-top: 5px;
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
        }

        .health-bar-fill {
            height: 100%;
            background: var(--success-color);
            width: 100%;
            transition: width 0.3s;
        }

        .shake { animation: shake 0.5s; }
        .attack-anim { animation: lunge 0.3s; }

        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        @keyframes lunge {
            0% { transform: scaleX(-1) translateX(0); }
            50% { transform: scaleX(-1) translateX(-50px); }
            100% { transform: scaleX(-1) translateX(0); }
        }

        /* --- Word Display --- */
        #word-display {
            font-size: 1.5rem;
            letter-spacing: 5px;
            text-align: center;
            margin: 20px 0;
            min-height: 40px;
            text-shadow: 2px 2px 0 #fff;
        }

        .letter-slot {
            display: inline-block;
            border-bottom: 3px solid #333;
            min-width: 20px;
            margin: 0 2px;
        }

        .letter-slot.filled { border-bottom: none; }
        .letter-slot.hint { color: #555; opacity: 0.6; }

        /* --- Controls --- */
        #controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .btn {
            background: #fff;
            border: 4px solid #333;
            box-shadow: 4px 4px 0 #333;
            padding: 15px 5px;
            font-family: inherit;
            font-size: 0.7rem;
            cursor: pointer;
            text-transform: uppercase;
            active: transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .btn:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 #333;
        }

        .btn-icon { font-size: 1.5rem; margin-bottom: 5px; }

        /* --- Energy/XP Bar --- */
        #xp-container {
            width: 100%;
            height: 20px;
            background: #333;
            border: 2px solid #fff;
            margin-top: auto; /* Push to bottom */
            position: relative;
        }

        #xp-fill {
            height: 100%;
            background: var(--accent-color);
            width: 0%;
            transition: width 0.5s ease-out;
        }

        #xp-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.6rem;
            color: #000;
            width: 100%;
            text-align: center;
        }

        /* --- Hidden Input for Mobile Keyboard --- */
        #hidden-input {
            position: absolute;
            opacity: 0;
            top: -1000px;
        }
        
        /* Mobile keyboard keep-alive overlay */
        #keyboard-trigger {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 5;
            display: none; /* Shown only when needed */
        }

        /* --- Modal --- */
        #modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s;
        }

        #modal-overlay.visible {
            visibility: visible;
            opacity: 1;
        }

        .modal-content {
            background: #fff;
            padding: 20px;
            border: 4px solid #333;
            text-align: center;
            max-width: 80%;
        }
        
        .modal-title {
            color: var(--danger-color);
            margin-bottom: 15px;
        }
        
        .modal-btn {
            background: var(--success-color);
            color: white;
            border: none;
            padding: 15px 30px;
            font-family: inherit;
            margin-top: 15px;
            cursor: pointer;
            font-size: 1rem;
        }

        /* Feedback text floating */
        .feedback {
            position: absolute;
            font-size: 1.2rem;
            font-weight: bold;
            pointer-events: none;
            animation: floatUp 1s forwards;
            z-index: 20;
        }

        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }

    </style>
</head>
<body>

<div id="game-container">
    <header>
        <div class="stats-box">
            <span>LVL <span id="level-display">1</span></span>
        </div>
        <div class="stats-box">
            <div id="hearts-container">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
        </div>
        <div class="stats-box">
            <span>Score: <span id="score-display">0</span></span>
        </div>
    </header>

    <div id="arena">
        <div id="hero" class="character">
            <div id="hero-sprite">üêù</div>
            <div class="health-bar-container"><div id="hero-hp" class="health-bar-fill"></div></div>
        </div>
        <div id="enemy" class="character">
            <div id="enemy-sprite">üëæ</div>
            <div class="health-bar-container"><div id="enemy-hp" class="health-bar-fill"></div></div>
        </div>
    </div>

    <div id="word-display">
        <!-- Spans injected here -->
    </div>

    <div id="controls">
        <button class="btn" id="btn-speak" onclick="game.speakWord()">
            <span class="btn-icon">üîä</span>
            Word
        </button>
        <button class="btn" id="btn-peek" onclick="game.peek()">
            <span class="btn-icon">üëÅÔ∏è</span>
            Peek
        </button>
        <button class="btn" id="btn-story" onclick="game.speakDefinition()">
            <span class="btn-icon">üìñ</span>
            Story
        </button>
    </div>

    <div id="xp-container">
        <div id="xp-fill"></div>
        <div id="xp-text">ENERGY (LEVEL UP)</div>
    </div>
    
    <!-- Hidden input to capture mobile keyboard -->
    <input type="text" id="hidden-input" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
    <div id="keyboard-trigger"></div>
</div>

<div id="modal-overlay">
    <div class="modal-content">
        <h2 class="modal-title" id="modal-title">GAME OVER</h2>
        <p id="modal-message">Try again?</p>
        <button class="modal-btn" onclick="game.resetGame()">RESTART</button>
    </div>
</div>

<script>
/**
 * SpellQuest Game Logic
 * 
 * Features:
 * - Robust State Machine (STATES object) to prevent race conditions.
 * - Adaptive difficulty based on levels.
 * - Mobile-first keyboard handling.
 */

// --- Data ---
const WORD_LISTS = {
    grade3: ["unicorn", "pirates", "leaning", "acrobat", "forepaw", "recipe", "mermaid", "incredible", "nervous", "raise", "attacked", "streetlights", "shouting", "dinosaur", "gorgeous", "avocado", "formation", "faraway", "understand", "breakfast", "message", "elephant", "garbage", "bombarded", "leather", "peppercorn", "weather", "turnout", "journey", "asleep", "brilliant", "monsoon", "valentine", "especially", "heater", "wooden", "window", "chocolate", "hedgehog", "surprise", "disability", "countess", "cartwheel", "zooming", "eaten", "courtyard", "curious", "vacuum", "dangerous", "February"],
    grade4: ["hesitate", "fragments", "ration", "frustration", "aroma", "perfume", "discoveries", "prognosis", "gallop", "fluently", "sardines", "rickety", "porridge", "beige", "gaunt", "nautical", "foreign", "scorcher", "deflated", "cosmetics", "unruly", "moustache", "sinister", "lurches", "Buffalo", "fabulous", "mysterious", "anguish", "lilt", "democracy", "ancestral", "enormous", "dubious", "scavenger", "unleash", "crawdad", "mascot", "artifacts", "tuxedo", "language", "sequins", "lanky", "brandished", "conical", "pediatric", "rummage", "grimace", "geranium", "ebony", "paltry"],
    grade5: ["verdict", "imitation", "preamble", "commotion", "steeple", "suspicious", "fugitive", "nomad", "Berlin", "bracken", "rakish", "gusto", "jeered", "galore", "eccentric", "hippies", "pistachio", "garbled", "miniature", "plausible", "oblivion", "spectators", "parchment", "heron", "billowed", "lunacy", "noggin", "hypnosis", "toiletries", "winsome", "emporium", "savant", "samosas", "mosque", "encourages", "receptionist", "reprimanding", "immigrants", "lanyards", "ramshackle", "dissolving", "skewer", "conjure", "neon", "rotunda", "gleaned", "prattling", "atrium", "almanac", "campaign"],
    grade6: ["zombielike", "convulsively", "graffitist", "cavorting", "battlements", "khaki", "Yiddish", "equestrian", "manticores", "guttural", "sans serif", "Frankenstein", "vidimus", "archipelago", "pinioning", "galleon", "wainscoting", "warlock", "dimensional", "Everest", "marauder", "deferential", "opalescent", "talcum", "plaited", "prestigious", "lo mein", "psyche", "schema", "delphine", "serape", "chignon", "magnanimous", "Nehru", "colossus", "garishly", "dexterity", "conscience", "albatross", "asphalt", "tranquilizer", "monsieur", "fraidycat", "courier", "stucco", "et cetera", "slough", "puissance", "pheromone", "chartreuse"]
};

// --- Context Sentences for Story Mode ---
const SENTENCES = {
    // Grade 3
    "unicorn": "The magical unicorn had a shimmering silver horn.",
    "pirates": "The pirates sailed the high seas looking for gold.",
    "leaning": "She was leaning against the fence while waiting for the bus.",
    "acrobat": "The acrobat performed amazing flips on the tightrope.",
    "forepaw": "The bear lifted its forepaw to scratch its nose.",
    "recipe": "My grandmother has a secret recipe for chocolate chip cookies.",
    "mermaid": "The mermaid swam deep under the ocean waves.",
    "incredible": "The view from the mountaintop was absolutely incredible.",
    "nervous": "He felt nervous before his big piano recital.",
    "raise": "Please raise your hand if you know the answer.",
    "attacked": "The castle was attacked by a fierce dragon.",
    "streetlights": "The streetlights flickered on as the sun went down.",
    "shouting": "We could hear someone shouting for help in the distance.",
    "dinosaur": "The T-Rex is a very famous meat-eating dinosaur.",
    "gorgeous": "The bride looked gorgeous in her white wedding dress.",
    "avocado": "I like to spread smashed avocado on my toast.",
    "formation": "The fighter jets flew in a perfect V formation.",
    "faraway": "She dreamed of traveling to a faraway land.",
    "understand": "Do you understand the instructions for the assignment?",
    "breakfast": "Pancakes and eggs are my favorite breakfast foods.",
    "message": "He sent a text message to his best friend.",
    "elephant": "The elephant used its trunk to spray water.",
    "garbage": "Please take the garbage out to the curb.",
    "bombarded": "The goalie was bombarded with soccer balls during practice.",
    "leather": "He wore a brown leather jacket to the party.",
    "peppercorn": "The chef ground a black peppercorn over the salad.",
    "weather": "The weather forecast predicts rain for tomorrow.",
    "turnout": "There was a huge turnout at the school talent show.",
    "journey": "The journey across the desert took forty days.",
    "asleep": "The baby fell asleep in her mother's arms.",
    "brilliant": "The scientist had a brilliant idea that changed the world.",
    "monsoon": "The heavy rains of the monsoon season flooded the streets.",
    "valentine": "He gave her a red rose as a valentine gift.",
    "especially": "I like ice cream, especially mint chocolate chip.",
    "heater": "We turned on the heater because the room was freezing.",
    "wooden": "The old wooden chair creaked when I sat on it.",
    "window": "Please open the window to let some fresh air in.",
    "chocolate": "She ate a piece of dark chocolate for dessert.",
    "hedgehog": "The hedgehog rolled into a ball when it felt threatened.",
    "surprise": "We planned a surprise birthday party for Dad.",
    "disability": "His disability never stopped him from achieving his dreams.",
    "countess": "The countess lived in a grand estate in the countryside.",
    "cartwheel": "She did a perfect cartwheel on the grass.",
    "zooming": "The race cars were zooming around the track.",
    "eaten": "Who has eaten all the cookies in the jar?",
    "courtyard": "We sat in the courtyard and enjoyed the sunshine.",
    "curious": "The curious cat investigated the empty box.",
    "vacuum": "I need to vacuum the rug before the guests arrive.",
    "dangerous": "It is dangerous to text while driving.",
    "February": "February is the shortest month of the year.",

    // Grade 4
    "hesitate": "Do not hesitate to ask for help if you need it.",
    "fragments": "The vase shattered into tiny fragments on the floor.",
    "ration": "The soldiers had to ration their food during the mission.",
    "frustration": "She sighed in frustration when the computer crashed.",
    "aroma": "The aroma of fresh bread filled the kitchen.",
    "perfume": "She wore a floral perfume that smelled like roses.",
    "discoveries": "Scientists make new discoveries every day.",
    "prognosis": "The doctor said the prognosis for recovery is very good.",
    "gallop": "The horse began to gallop across the open field.",
    "fluently": "He speaks three languages fluently.",
    "sardines": "Some people like to eat sardines on crackers.",
    "rickety": "We walked carefully across the rickety old bridge.",
    "porridge": "Goldilocks ate the bear's porridge.",
    "beige": "The walls of the waiting room were painted a dull beige.",
    "gaunt": "The stray dog looked gaunt and hungry.",
    "nautical": "The room was decorated with a nautical theme, including anchors and ropes.",
    "foreign": "They enjoyed trying foreign foods during their vacation.",
    "scorcher": "It was a real scorcher of a day, over 100 degrees.",
    "deflated": "The balloon slowly deflated after the party.",
    "cosmetics": "She bought new cosmetics at the beauty store.",
    "unruly": "The teacher struggled to control the unruly class.",
    "moustache": "He grew a thick moustache for the movie role.",
    "sinister": "The haunted house had a sinister appearance.",
    "lurches": "The train lurches forward when it starts moving.",
    "Buffalo": "The Buffalo roamed the plains in large herds.",
    "fabulous": "She looked fabulous in her new evening gown.",
    "mysterious": "A mysterious stranger appeared at the door.",
    "anguish": "You could see the anguish on his face when he lost the game.",
    "lilt": "She spoke with a cheerful lilt in her voice.",
    "democracy": "In a democracy, citizens vote for their leaders.",
    "ancestral": "They visited their ancestral home in Ireland.",
    "enormous": "The elephant is an enormous animal.",
    "dubious": "He looked dubious about the plan to build a rocket.",
    "scavenger": "The vulture is a scavenger that eats dead animals.",
    "unleash": "The storm will unleash its fury tonight.",
    "crawdad": "We caught a crawdad in the creek.",
    "mascot": "The team mascot danced on the sidelines.",
    "artifacts": "The museum displayed ancient artifacts from Egypt.",
    "tuxedo": "He wore a black tuxedo to the formal dance.",
    "language": "Learning a second language is good for your brain.",
    "sequins": "Her dress was covered in sparkling sequins.",
    "lanky": "The lanky teenager bumped his head on the doorframe.",
    "brandished": "The knight brandished his sword at the dragon.",
    "conical": "The witch wore a tall, conical hat.",
    "pediatric": "She works as a nurse in the pediatric ward.",
    "rummage": "I had to rummage through my drawer to find my keys.",
    "grimace": "He made a grimace when he tasted the sour lemon.",
    "geranium": "She planted a red geranium in the flower pot.",
    "ebony": "The piano keys were made of ivory and ebony.",
    "paltry": "He was paid a paltry sum for all his hard work.",

    // Grade 5
    "verdict": "The jury delivered a verdict of not guilty.",
    "imitation": "It wasn't real silk, just a cheap imitation.",
    "preamble": "The Preamble to the Constitution starts with 'We the People'.",
    "commotion": "There was a loud commotion in the hallway.",
    "steeple": "The church steeple reached high into the sky.",
    "suspicious": "The security guard saw a suspicious person near the gate.",
    "fugitive": "The police are searching for the escaped fugitive.",
    "nomad": "The nomad traveled from place to place without a permanent home.",
    "Berlin": "Berlin is the capital city of Germany.",
    "bracken": "The deer hid in the thick bracken in the forest.",
    "rakish": "He wore his hat at a rakish angle.",
    "gusto": "She ate her dinner with great gusto.",
    "jeered": "The crowd jeered when the opposing team took the field.",
    "galore": "There were balloons and candy galore at the carnival.",
    "eccentric": "The eccentric millionaire lived in a house shaped like a shoe.",
    "hippies": "The hippies in the 1960s preached peace and love.",
    "pistachio": "My favorite ice cream flavor is pistachio.",
    "garbled": "The radio message was garbled and hard to understand.",
    "miniature": "She collects miniature dollhouse furniture.",
    "plausible": "His excuse for being late sounded plausible.",
    "oblivion": "The ancient city was lost to oblivion for centuries.",
    "spectators": "The spectators cheered loudly for their team.",
    "parchment": "The old map was drawn on yellowed parchment.",
    "heron": "The great blue heron stood motionless in the water.",
    "billowed": "Smoke billowed from the chimney.",
    "lunacy": "It would be sheer lunacy to go swimming in this storm.",
    "noggin": "Use your noggin and think of a solution!",
    "hypnosis": "The therapist used hypnosis to help him quit smoking.",
    "toiletries": "Don't forget to pack your toiletries like toothbrush and soap.",
    "winsome": "She had a winsome smile that charmed everyone.",
    "emporium": "They visited a large shopping emporium downtown.",
    "savant": "He is a math savant who can calculate huge numbers in his head.",
    "samosas": "We ordered vegetable samosas as an appetizer.",
    "mosque": "Muslims go to a mosque to pray.",
    "encourages": "My teacher encourages me to read more books.",
    "receptionist": "The receptionist greeted us when we entered the office.",
    "reprimanding": "The coach was reprimanding the player for being late.",
    "immigrants": "Many immigrants came to America seeking a better life.",
    "lanyards": "We wove colorful lanyards at summer camp.",
    "ramshackle": "The ramshackle hut looked like it would collapse in the wind.",
    "dissolving": "The sugar is dissolving in the hot tea.",
    "skewer": "He put the meat and vegetables on a wooden skewer.",
    "conjure": "The magician seemed to conjure a rabbit out of thin air.",
    "neon": "The neon sign buzzed and glowed in the night.",
    "rotunda": "The statue stood in the center of the capitol rotunda.",
    "gleaned": "She gleaned information from various old books.",
    "prattling": "The toddler was prattling on about his toy trucks.",
    "atrium": "The hotel had a glass-roofed atrium filled with plants.",
    "almanac": "Farmers often consult an almanac for weather predictions.",
    "campaign": "The mayor launched a campaign to clean up the city parks.",

    // Grade 6
    "zombielike": "The tired students walked through the hall in a zombielike state.",
    "convulsively": "His shoulders shook convulsively as he sobbed.",
    "graffitist": "The police caught the graffitist painting on the wall.",
    "cavorting": "The puppies were cavorting happily in the grass.",
    "battlements": "Archers stood on the castle battlements ready to defend.",
    "khaki": "The soldiers wore khaki uniforms to blend in with the sand.",
    "Yiddish": "My grandfather often uses Yiddish words when he speaks.",
    "equestrian": "She is an equestrian who loves riding horses.",
    "manticores": "Manticores are mythical beasts with a lion's body.",
    "guttural": "He made a low, guttural sound in his throat.",
    "sans serif": "Arial is a popular sans serif font.",
    "Frankenstein": "Dr. Frankenstein created a monster in his lab.",
    "vidimus": "The vidimus certified that the document was authentic.",
    "archipelago": "Hawaii is an archipelago consisting of many islands.",
    "pinioning": "The wrestler was pinioning his opponent to the mat.",
    "galleon": "The Spanish galleon was loaded with gold coins.",
    "wainscoting": "The dining room features elegant oak wainscoting.",
    "warlock": "The warlock cast a dark spell.",
    "dimensional": "We watched a three dimensional movie with special glasses.",
    "Everest": "Mount Everest is the highest peak in the world.",
    "marauder": "The masked marauder stole valuable jewels.",
    "deferential": "The waiter was very deferential to the customers.",
    "opalescent": "The soap bubble had an opalescent surface.",
    "talcum": "She dusted the baby with soft talcum powder.",
    "plaited": "She plaited her long hair into a braid.",
    "prestigious": "Harvard is a very prestigious university.",
    "lo mein": "I ordered chicken lo mein from the Chinese restaurant.",
    "psyche": "Fear can damage a person's psyche.",
    "schema": "The architect drew a schema of the building.",
    "delphine": "The delphine pottery had a beautiful blue color.",
    "serape": "He wore a colorful Mexican serape over his shoulders.",
    "chignon": "She wore her hair in a stylish chignon at the back of her head.",
    "magnanimous": "The winner was magnanimous and shook hands with the loser.",
    "Nehru": "He wore a Nehru jacket with a mandarin collar.",
    "colossus": "The statue was a colossus that towered over the harbor.",
    "garishly": "The room was painted garishly in bright orange and purple.",
    "dexterity": "Magicians need great manual dexterity for card tricks.",
    "conscience": "His conscience told him to return the lost wallet.",
    "albatross": "The albatross is a large seabird with a huge wingspan.",
    "asphalt": "The road crews laid fresh asphalt on the highway.",
    "tranquilizer": "The vet used a tranquilizer to calm the lion.",
    "monsieur": "The waiter addressed him as Monsieur.",
    "fraidycat": "Don't be a fraidycat, jump in the pool!",
    "courier": "The courier delivered the package by bike.",
    "stucco": "The house had a white stucco exterior.",
    "et cetera": "Bring pens, paper, pencils, et cetera.",
    "slough": "Snakes slough their skin as they grow.",
    "puissance": "The horse showed great puissance in the jumping competition.",
    "pheromone": "Insects use a pheromone to attract mates.",
    "chartreuse": "She wore a bright chartreuse dress to the party."
};

// --- Game State Constants ---
const STATES = {
    IDLE: 'IDLE',          // Waiting for user to start or between rounds
    PLAYING: 'PLAYING',    // Active typing
    LOCKED: 'LOCKED',      // Processing animation/transition (ignore input)
    GAMEOVER: 'GAMEOVER'   // Dead state
};

// --- Configuration ---
const CONFIG = {
    xpToLevel: 100,
    xpPerWord: 20,
    xpPenaltyPeek: 10,
    damagePerHit: 20, // Enemy takes 5 hits
    heroDamage: 25,   // Hero takes 4 hits
    maxHearts: 3
};

class Game {
    constructor() {
        this.state = STATES.IDLE;
        this.level = 1;
        this.score = 0;
        this.hearts = CONFIG.maxHearts;
        this.xp = 0;
        this.currentWord = "";
        this.typedWord = "";
        this.heroHP = 100;
        this.enemyHP = 100;
        
        // DOM Cache
        this.dom = {
            input: document.getElementById('hidden-input'),
            wordDisplay: document.getElementById('word-display'),
            heroSprite: document.getElementById('hero-sprite'),
            enemySprite: document.getElementById('enemy-sprite'),
            heroHP: document.getElementById('hero-hp'),
            enemyHP: document.getElementById('enemy-hp'),
            xpFill: document.getElementById('xp-fill'),
            level: document.getElementById('level-display'),
            score: document.getElementById('score-display'),
            hearts: document.getElementById('hearts-container'),
            modal: document.getElementById('modal-overlay'),
            modalTitle: document.getElementById('modal-title'),
            modalMsg: document.getElementById('modal-message'),
            kbTrigger: document.getElementById('keyboard-trigger')
        };

        this.init();
    }

    init() {
        // Setup Event Listeners
        this.dom.input.addEventListener('input', (e) => this.handleInput(e));
        
        // Ensure keyboard focus is maintained on click anywhere
        document.addEventListener('click', () => {
            if (this.state === STATES.PLAYING) {
                this.dom.input.focus();
            }
        });

        // Start game
        this.startLevel();
    }

    resetGame() {
        this.level = 1;
        this.score = 0;
        this.hearts = CONFIG.maxHearts;
        this.xp = 0;
        this.updateStats();
        this.dom.modal.classList.remove('visible');
        this.startLevel();
    }

    getWordList() {
        if (this.level <= 3) return WORD_LISTS.grade3;
        if (this.level <= 5) return WORD_LISTS.grade4;
        if (this.level <= 7) return WORD_LISTS.grade5;
        return WORD_LISTS.grade6;
    }

    getRandomWord() {
        const list = this.getWordList();
        return list[Math.floor(Math.random() * list.length)];
    }

    updateStats() {
        this.dom.level.innerText = this.level;
        this.dom.score.innerText = this.score;
        this.dom.hearts.innerText = "‚ù§Ô∏è".repeat(this.hearts);
        
        // XP Bar
        let xpPercent = (this.xp / CONFIG.xpToLevel) * 100;
        this.dom.xpFill.style.width = `${Math.min(xpPercent, 100)}%`;

        // Bee Evolution
        if (this.level >= 10) this.dom.heroSprite.innerText = "üêùüëë";
        else if (this.level >= 5) this.dom.heroSprite.innerText = "üêù‚ú®";
        else this.dom.heroSprite.innerText = "üêù";

        // Background Color Evolution
        if (this.level >= 7) document.body.style.backgroundColor = "var(--bg-color-lvl4)";
        else if (this.level >= 5) document.body.style.backgroundColor = "var(--bg-color-lvl3)";
        else if (this.level >= 3) document.body.style.backgroundColor = "var(--bg-color-lvl2)";
        else document.body.style.backgroundColor = "var(--bg-color-lvl1)";
    }

    startLevel() {
        this.state = STATES.LOCKED; // Lock during setup
        this.currentWord = this.getRandomWord();
        this.typedWord = "";
        this.heroHP = 100;
        this.enemyHP = 100;
        
        this.updateHealthUI();
        this.renderWord();
        this.updateStats();

        // Reset input
        this.dom.input.value = "";
        this.dom.input.focus();

        // Always auto-speak the word at start
        setTimeout(() => this.speakWord(), 500);

        this.state = STATES.PLAYING;
    }

    renderWord() {
        this.dom.wordDisplay.innerHTML = "";
        const letters = this.currentWord.split('');
        
        letters.forEach((char, index) => {
            const span = document.createElement('span');
            span.className = "letter-slot";
            
            // Logic for what to show
            if (index < this.typedWord.length) {
                // Correctly typed letter
                span.innerText = this.typedWord[index];
                span.classList.add('filled');
            } else {
                // Not yet typed
                if (this.level === 1) {
                    span.innerText = char; // Show all in Lvl 1
                    span.classList.add('hint');
                } else if (this.level === 2 && index === 0) {
                    span.innerText = char; // Show first letter Lvl 2
                    span.classList.add('hint');
                } else {
                    span.innerText = "_"; // Hidden
                }
            }
            this.dom.wordDisplay.appendChild(span);
        });
    }

    handleInput(e) {
        if (this.state !== STATES.PLAYING) {
            this.dom.input.value = ""; // Clear buffer if locked
            return;
        }

        const rawVal = this.dom.input.value.toLowerCase();
        // Get the last character typed
        const lastChar = rawVal.slice(-1);
        
        // Reset buffer to keep it clean, but keep focus
        // We only care about the *new* keystroke
        if (rawVal.length === 0) return; // Backspace or empty
        this.dom.input.value = ""; 

        const targetIndex = this.typedWord.length;
        const targetChar = this.currentWord[targetIndex].toLowerCase();

        if (lastChar === targetChar) {
            // Correct!
            this.typedWord += lastChar;
            this.renderWord();
            this.heroAttack();
            
            if (this.typedWord.length === this.currentWord.length) {
                this.handleWin();
            }
        } else {
            // Incorrect!
            this.enemyAttack();
        }
    }

    heroAttack() {
        this.enemyHP -= CONFIG.damagePerHit;
        if (this.enemyHP < 0) this.enemyHP = 0;
        this.updateHealthUI();
        
        // Animations
        this.dom.heroSprite.classList.add('attack-anim');
        this.dom.enemySprite.classList.add('shake');
        this.showFloatingText(this.dom.enemySprite, "POW!", "red");

        setTimeout(() => {
            this.dom.heroSprite.classList.remove('attack-anim');
            this.dom.enemySprite.classList.remove('shake');
        }, 300);
    }

    enemyAttack() {
        this.heroHP -= CONFIG.heroDamage;
        if (this.heroHP < 0) this.heroHP = 0;
        this.updateHealthUI();

        // Animations
        this.dom.enemySprite.classList.add('attack-anim');
        this.dom.heroSprite.classList.add('shake');
        this.showFloatingText(this.dom.heroSprite, "OUCH!", "orange");

        setTimeout(() => {
            this.dom.enemySprite.classList.remove('attack-anim');
            this.dom.heroSprite.classList.remove('shake');
        }, 300);

        if (this.heroHP === 0) {
            this.handleDeath();
        }
    }

    updateHealthUI() {
        this.dom.heroHP.style.width = `${this.heroHP}%`;
        this.dom.enemyHP.style.width = `${this.enemyHP}%`;
    }

    handleWin() {
        this.state = STATES.LOCKED;
        this.showFloatingText(this.dom.heroSprite, "VICTORY!", "gold");
        
        // XP Gain
        this.xp += CONFIG.xpPerWord;
        this.score += 100;
        
        // Check Level Up
        if (this.xp >= CONFIG.xpToLevel) {
            this.level++;
            this.xp = 0; // Reset bar or carry over logic
            this.showFloatingText(this.dom.heroSprite, "LEVEL UP!", "#00ff00");
            // Play sound?
        }

        this.updateStats();

        // Delay next word
        setTimeout(() => {
            this.startLevel();
        }, 1500);
    }

    handleDeath() {
        this.state = STATES.LOCKED;
        this.hearts--;
        this.updateStats();

        if (this.hearts <= 0) {
            // Game Over
            this.state = STATES.GAMEOVER;
            this.dom.modalTitle.innerText = "GAME OVER";
            this.dom.modalMsg.innerText = `Final Score: ${this.score}`;
            this.dom.modal.classList.add('visible');
        } else {
            // Revive
            this.showFloatingText(this.dom.heroSprite, "REVIVED!", "pink");
            setTimeout(() => {
                this.heroHP = 100;
                this.updateHealthUI();
                this.state = STATES.PLAYING;
                this.dom.input.focus();
            }, 1000);
        }
    }

    // --- Actions ---
    speakWord() {
        const u = new SpeechSynthesisUtterance(this.currentWord);
        u.rate = 0.8;
        window.speechSynthesis.speak(u);
        this.dom.input.focus();
    }

    speakDefinition() {
        let text = SENTENCES[this.currentWord];
        if (!text) text = `Spell the word ${this.currentWord}.`;
        
        // Replace target word with "blank" for the spoken audio
        // Regex to match case-insensitive word boundaries
        const regex = new RegExp(`\\b${this.currentWord}\\b`, 'gi');
        const spokenText = text.replace(regex, "blank");

        const u = new SpeechSynthesisUtterance(spokenText);
        window.speechSynthesis.speak(u);
        this.dom.input.focus();
    }

    peek() {
        if (this.state !== STATES.PLAYING) return;
        
        // Show next letter temporarily
        const idx = this.typedWord.length;
        if (idx >= this.currentWord.length) return;

        const char = this.currentWord[idx];
        
        // Create visual hint
        const slots = document.getElementsByClassName('letter-slot');
        const slot = slots[idx];
        const originalText = slot.innerText;
        
        slot.innerText = char;
        slot.style.color = "red";
        
        // Cost
        if (this.xp > 0) {
            this.xp = Math.max(0, this.xp - CONFIG.xpPenaltyPeek);
            this.updateStats();
        }

        setTimeout(() => {
            slot.innerText = originalText;
            slot.style.color = "";
            if (slot.classList.contains('hint')) {
                 slot.style.color = "#555";
            }
        }, 1000);
        
        this.dom.input.focus();
    }

    showFloatingText(element, text, color) {
        const rect = element.getBoundingClientRect();
        const floatEl = document.createElement('div');
        floatEl.innerText = text;
        floatEl.className = 'feedback';
        floatEl.style.color = color;
        floatEl.style.left = rect.left + 'px';
        floatEl.style.top = rect.top + 'px';
        
        document.body.appendChild(floatEl);
        
        setTimeout(() => {
            floatEl.remove();
        }, 1000);
    }
}

// Start
const game = new Game();

</script>
</body>
</html>